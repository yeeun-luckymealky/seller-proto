# 예약 플로우 리디자인 Epic 명세서

> **전체 플로우**: 가게 상세 (CTA) → 결제하기 → 결제 완료/실패
>
> **AS-IS 기준**: `/Desktop/lucky/luckymeal-frontend-main` (실제 운영 코드)
> **TO-BE 참고**: `/Desktop/lseller` (프로토타입)

---

# Epic 1: 가게 상세 - 하단 CTA

## 01/ 프로덕트 기능 명세

### 1-1. 목표(배경)

**배경**
- 가게 상세 페이지에 진입한 소비자가 **CTA 버튼을 더 누르고 싶게** 만드는 것이 핵심

**현황**

| 구분 | AS-IS (운영) | TO-BE |
|------|-------------|-------|
| 버튼 문구 | "오늘 픽업 예약하기 (N개 남음)" | 유지 또는 개선 검토 |
| 재고 표시 | 5개 초과 시 "5+" 표시 | 실제 개수 표시 검토 |
| 긴급 표시 | 없음 | 재고 ≤2개 시 긴급 강조 |
| 품절 상태 | 알림받기 버튼으로 전환 | 유지 |

**목표 지표**
- Primary Metric: **CTA 클릭률** (가게 상세 PV → 결제하기 진입)
- Success Criteria: 클릭률 +15% 이상

---

### 1-2. 요구사항

**`Must-have`**

| Story ID | 상태 | 현재 동작 | 개선안 |
|----------|------|----------|--------|
| 1-1 | TODAY_OPEN | "오늘 픽업 예약하기 (N개 남음)" 초록 버튼 | 유지 |
| 1-2 | TOMORROW_OPEN | "내일 픽업 예약하기 (N개 남음)" 파란 버튼 | 유지 |
| 1-3 | 그 외 (마감/품절) | "예약 오픈 알림받기" 회색 버튼 | 유지 |
| 1-4 | 재고 ≤2개 | 일반 표시 | **긴급 강조** ("서두르세요! 마지막 N개") |
| 1-5 | 재고 표시 | 5개 초과 시 "5+" | 실제 개수 표시 검토 |

**`Nice-to-have`**

| 기능 | 설명 | 기대 효과 |
|------|------|----------|
| 절약 금액 표시 | CTA 위에 "3,500원 절약!" | 가치 강조 |
| 마감 임박 표시 | 픽업 시간 1시간 전 긴급 표시 | FOMO 유발 |

**`Out of Scope`**
- 가게 상세 페이지 전체 리디자인 (CTA만 다룸)

---

### 1-3. 고려사항/비고

**UX 라이팅 검토**

| 현재 | 대안 1 | 대안 2 |
|------|--------|--------|
| "오늘 픽업 예약하기" | "지금 예약하기" | "럭키백 예약하기" |
| "(5+개 남음)" | "(6개 남음)" | "6개 남았어요!" |

---

## 02/ Case 분기

| Case | 조건 | 버튼 상태 |
|------|------|----------|
| 오늘 오픈 | status = TODAY_OPEN | 초록, "오늘 픽업 예약하기 (N개 남음)" |
| 내일 오픈 | status = TOMORROW_OPEN | 파란, "내일 픽업 예약하기 (N개 남음)" |
| 재고 긴급 | luckyBagCount ≤ 2 | **긴급 스타일** 추가 |
| 품절/마감 | 그 외 status | 회색, "예약 오픈 알림받기" |

---

## Figure Out...

**Scope 확정**
- [ ] 재고 긴급 표시 기준: 2개 이하? 3개 이하?
- [ ] "5+" 대신 실제 개수 표시할지?
- [ ] 긴급 표시 디자인: 색상 변경? 아이콘 추가? 애니메이션?

**API 명세**
- [ ] 없음 (기존 가게 상세 API의 `luckyBagCount`, `status` 활용)

---
---

# Epic 2: 결제하기 화면

## 01/ 프로덕트 기능 명세

### 1-1. 목표(배경)

**배경**
- 결제하기 화면은 예약 전환의 **최종 관문**
- 현재 여러 UX 문제로 이탈 및 CS 발생

**현재 우리가 경험하는 문제**

| # | 문제 | AS-IS 상세 | 영향 |
|---|------|-----------|------|
| 1 | **이용 매너 안내가 무의미** | 3단계 스텝 페이지 (visitTime → menu → confirmedTime) 별도 페이지네이션 | 매번 반복 → 그냥 넘김 → 안내 효과 없음 |
| 2 | **쿠폰 개수가 안 보임** | "쿠폰을 선택해주세요" 또는 "사용가능한 쿠폰 없음"만 표시 | 쿠폰 있는지 모르고 지나침 |
| 3 | **쿠폰 선택이 전체 페이지** | Portal로 전체 화면 모달 이동 | 맥락 단절, 이탈 증가 |

**현황**

| 구분 | AS-IS (운영) | TO-BE |
|------|-------------|-------|
| 이용 매너 | **3단계 스텝 페이지** 별도 이동 | **체크박스 동의** (한 화면, 필수 체크) |
| 쿠폰 표시 | 개수 없음 | **"N개 보유" 뱃지** 추가 |
| 쿠폰 선택 | **전체 페이지 Portal** | **하단 바텀시트** |
| 결제 버튼 | 바로 활성화 | **체크 동의 시 활성화** |

**목표 지표**
- Primary Metric: **결제 완료율** (결제하기 진입 → 결제 성공)
- Secondary Metric: 쿠폰 사용률
- Success Criteria:
  - 결제 완료율 +10% 이상
  - 쿠폰 사용률 +20% 이상
  - 픽업 노쇼율 -15% 이상

---

### 1-2. 요구사항

**`Must-have`**

#### A. 이용 매너 안내 개선 (핵심)

| Story ID | AS-IS | TO-BE |
|----------|-------|-------|
| 2-A-1 | 3단계 스텝 페이지 별도 이동 | **제거** - 결제 화면 내 체크박스로 통합 |
| 2-A-2 | 페이지별 "다음" 버튼 | **체크박스 1개** ("럭키밀 이용 안내를 확인했어요") |
| 2-A-3 | 안내 내용 3페이지 분산 | **한 카드에 3줄 요약** |
| 2-A-4 | 체크 없이 결제 가능 | **체크 필수** - 미체크 시 결제 버튼 비활성화 |

**이용 안내 내용 (간소화):**
```
• 픽업 시간을 꼭 지켜주세요
• 메뉴는 재고에 따라 달라요
• 확정은 픽업 30분 전에 돼요
```

#### B. 쿠폰 선택 개선 (핵심)

| Story ID | AS-IS | TO-BE |
|----------|-------|-------|
| 2-B-1 | 쿠폰 개수 표시 없음 | **"N개 보유" 뱃지** 파란색 |
| 2-B-2 | 전체 페이지 Portal | **하단 바텀시트** |
| 2-B-3 | 쿠폰 없을 때: "사용가능한 쿠폰 없음" | "보유 쿠폰 없음" + 터치 비활성화 |
| 2-B-4 | - | 선택된 쿠폰: **"-N원"** 초록색 표시 |

#### C. 결제 버튼

| Story ID | AS-IS | TO-BE |
|----------|-------|-------|
| 2-C-1 | "결제하기" 바로 활성화 | 이용 안내 **체크 시 활성화** |
| 2-C-2 | - | 미체크 시 버튼 터치 → 체크박스 강조 피드백 |

#### D. 기존 유지

| 기능 | 현재 상태 | 변경 |
|------|----------|------|
| 지도 + Drawer 구조 | Drawer 요약형/상세형 | 유지 |
| 수량 조절 | CounterInput | 유지 |
| 픽업 시간 표시 | "오늘/내일 HH:MM~HH:MM" | 유지 |
| 총 결제 가격 | 원가 취소선 + 할인가 | 유지 |

---

**`Nice-to-have`**

| 우선순위 | 기능 | 설명 |
|----------|------|------|
| P1 | 쿠폰 자동 적용 | 최대 할인 쿠폰 자동 선택 |
| P2 | 만료 임박 쿠폰 표시 | D-3 이내 "곧 만료" |

**`Out of Scope`**
- 결제 수단 UI 변경 (현재 토스페이먼츠 연동)
- 포인트 사용

---

### 1-3. 고려사항/비고

**플로우 변경**

```
AS-IS:
가게 상세 → [이용매너 3단계] → 결제하기(Drawer) → 결제

TO-BE:
가게 상세 → 결제하기(Drawer + 체크박스) → 결제
```

**기술 고려사항**
- 이용 매너 퍼널(`UsageMannerFunnel.tsx`) 제거 또는 스킵 처리
- `OrderFunnel.tsx`에서 `usageManner` 스텝 제거
- `CouponSelector.tsx` Portal → BottomSheet 컴포넌트로 변경

---

## 02/ Case 분기

### 이용 안내 체크

| Case | 조건 | 동작 |
|------|------|------|
| 미체크 | agreed = false | 결제 버튼 비활성화 (회색) |
| 체크 | agreed = true | 결제 버튼 활성화 (초록) |
| 미체크 + 버튼 터치 | - | 체크박스 강조 애니메이션 |

### 쿠폰

| Case | 조건 | 동작 |
|------|------|------|
| 쿠폰 0개 | coupons.length = 0 | "보유 쿠폰 없음", 터치 비활성화 |
| 쿠폰 있음 | coupons.length > 0 | "N개 보유" 뱃지, 터치 시 바텀시트 |
| 쿠폰 선택 | selectedCoupon != null | "-N원" 초록색 표시 |
| 쿠폰 해제 | 같은 쿠폰 재터치 | 선택 해제, 원래 금액 |

---

## Figure Out...

### Scope 확정
- [ ] 이용 매너 3단계 **완전 제거** vs **스킵 가능하게**?
- [ ] 쿠폰 자동 적용 이번 scope에 포함?
- [ ] 바텀시트 라이브러리: 기존 Drawer 활용? 별도 구현?

### 기술 확인
- [ ] `UsageMannerFunnel` 제거 시 영향 범위?
- [ ] `CouponSelector` Portal → BottomSheet 공수?

### API 명세
- [ ] 없음 (기존 API 활용)
  - 쿠폰 목록: `GET /api/coupons` (기존)
  - 쿠폰 개수: 기존 응답의 `data.length` 활용
  - 주문 생성: `POST /api/orders` (기존)

---
---

# Epic 3: 결제 완료 화면

## 01/ 프로덕트 기능 명세

### 1-1. 목표(배경)

**배경**
- 결제 완료 후 **긍정적 경험** 제공 및 **다음 액션** 유도

**현재 우리가 경험하는 문제**

| # | 문제 | AS-IS 상세 | 영향 |
|---|------|-----------|------|
| 1 | **용어 혼란** | "확정은 픽업시간 30분 전 **결정**됩니다" | "예약/확정/결정" 혼재 → 사용자 혼란 |
| 2 | **CTA 불명확** | "주문 현황 페이지로 가기" | 어디로 가는지, 왜 가야하는지 모호 |

**현황**

| 구분 | AS-IS (운영) | TO-BE |
|------|-------------|-------|
| 타이틀 | "럭키백 예약 완료!" | 유지 |
| 안내 문구 | "확정은 픽업시간 30분 전 **결정**됩니다!" | "**18:30**에 확정 알림을 보내드릴게요 :)" |
| CTA | "주문 현황 페이지로 가기" | "**예약 내역 확인하기**" |
| 추가 정보 | 없음 | **예약 정보 카드** (가게, 픽업시간, 금액) |
| 추천 | 없음 | **근처 가게 추천** (같이 픽업 가능) |

**목표 지표**
- Primary Metric: CTA 클릭률
- Secondary Metric: 추천 가게 클릭률
- Success Criteria: CTA 클릭률 +10%

---

### 1-2. 요구사항

**`Must-have`**

| Story ID | AS-IS | TO-BE |
|----------|-------|-------|
| 3-1 | "확정은 30분 전 결정됩니다" | "**{HH:MM}**에 확정 알림을 보내드릴게요 :)" (구체적 시간) |
| 3-2 | "주문 현황 페이지로 가기" | "**예약 내역 확인하기**" (명확한 문구) |
| 3-3 | 정보 없음 | **예약 정보 카드** (가게명, 주소, 픽업시간, 결제금액) |
| 3-4 | 추천 없음 | **근처 가게 추천** "근처에서 같이 픽업할 수 있어요" |

**용어 통일:**
```
예약 = 결제 완료 상태 (아직 확정 전)
확정 = 가게가 준비 완료 확인 (픽업 30분 전)
픽업 = 실제 수령
```

**`Nice-to-have`**

| 기능 | 설명 |
|------|------|
| CO2 절감 카드 | "약 Ng CO2 절감" 환경 기여 표시 |
| 축하 애니메이션 | confetti |

**`Out of Scope`**
- 예약 변경/취소 (주문 내역에서 처리)

---

### 1-3. 고려사항/비고

**UX 라이팅 개선**

| 요소 | AS-IS | TO-BE | 이유 |
|------|-------|-------|------|
| 확정 안내 | "30분 전 결정됩니다" | "18:30에 확정 알림 보내드릴게요" | 구체적 시간 > 상대적 시간 |
| CTA | "주문 현황 페이지로 가기" | "예약 내역 확인하기" | "페이지" 제거, 행동 중심 |

---

## 02/ Case 분기

| Case | 조건 | 동작 |
|------|------|------|
| 추천 가게 있음 | nearbyStores.length > 0 | 최대 3개 표시 |
| 추천 가게 없음 | nearbyStores.length = 0 | 섹션 숨김 |
| 추천 가게 터치 | - | 해당 가게 상세로 이동 |

---

## Figure Out...

### Scope 확정
- [ ] 추천 가게 정렬 기준? (거리순 vs 마감임박순)
- [ ] 추천 가게 조건: 재고 있는 것만? 픽업 시간 겹치는 것만?
- [ ] CO2 절감 카드 이번 scope 포함?

### API 명세 (신규 필요)

#### 1. 근처 추천 가게 목록 API
```
GET /api/places/nearby?lat={위도}&lng={경도}&excludePlaceId={현재가게ID}
```

**Request**
| 파라미터 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| lat | number | Y | 현재 위치 위도 |
| lng | number | Y | 현재 위치 경도 |
| excludePlaceId | number | N | 제외할 가게 ID (현재 주문한 가게) |
| limit | number | N | 최대 개수 (기본 3) |

**Response**
```json
{
  "success": true,
  "data": [
    {
      "id": 123,
      "name": "가게명",
      "distance": 350,
      "luckyBagCount": 5,
      "status": "TODAY_OPEN",
      "luckyBag": {
        "price": 7000,
        "discountPrice": 3500
      },
      "pickupTime": { "startTime": "19:00", "endTime": "20:00" },
      "thumbnailImage": "https://..."
    }
  ]
}
```

**필터 조건**
- `luckyBagCount > 0` (재고 있음)
- `status IN ('TODAY_OPEN', 'TOMORROW_OPEN')` (픽업 가능)

#### 2. 주문 상세 정보 (결제 완료 시 표시용)
- [ ] 기존 주문 상세 API 활용 가능한지 확인 필요
- [ ] 결제 완료 시 리턴되는 데이터에 가게명/주소/픽업시간 포함 여부 확인

---
---

# Epic 4: 결제 실패 화면

## 01/ 프로덕트 기능 명세

### 1-1. 목표(배경)

**배경**
- 결제 실패는 사용자에게 **부정적 경험**
- 빠른 재시도 또는 **대안 제공**으로 이탈 방지

**현재 우리가 경험하는 문제**

| # | 문제 | AS-IS 상세 | 영향 |
|---|------|-----------|------|
| 1 | **CTA가 "주문 현황"** | 결제 실패했는데 왜 주문 현황으로 가야 하는지? | 사용자 혼란, 재결제 포기 |
| 2 | **대안 없음** | 근처 가게 추천 없음 | 서비스 이탈 |

**현황**

| 구분 | AS-IS (운영) | TO-BE |
|------|-------------|-------|
| 타이틀 | "결제가 되지 않았어요" | 유지 |
| 메인 CTA | **"주문 현황 페이지로 가기"** | **"다시 결제하기"** |
| 보조 CTA | 없음 | "홈으로 돌아가기" |
| 추천 | **없음** | **근처 픽업 가능 가게** 추천 |
| 고객센터 | "고객센터 바로가기" 링크 | 유지 |

**목표 지표**
- Primary Metric: **재결제 시도율**
- Secondary Metric: 이탈률, 추천 가게 클릭률
- Success Criteria: 재결제 시도율 60% 이상

---

### 1-2. 요구사항

**`Must-have`**

| Story ID | AS-IS | TO-BE |
|----------|-------|-------|
| 4-1 | CTA "주문 현황 페이지로 가기" | **"다시 결제하기"** (메인 CTA) |
| 4-2 | - | **"홈으로 돌아가기"** (보조 CTA) |
| 4-3 | 추천 없음 | **근처 픽업 가능 가게** 추천 (가로 스크롤) |
| 4-4 | - | 추천 조건: 재고 > 0 AND 픽업 시간 내 |

**`Nice-to-have`**

| 기능 | 설명 |
|------|------|
| 실패 원인 상세 | PG 오류 코드에 따른 안내 |
| 다른 결제 수단 바로 선택 | 재결제 시 결제 수단 바텀시트 바로 노출 |

**`Out of Scope`**
- 자동 재시도
- 실시간 고객센터 채팅

---

### 1-3. 고려사항/비고

**CTA 변경 핵심**
```
AS-IS: 결제 실패 → "주문 현황 페이지로 가기" (?)
TO-BE: 결제 실패 → "다시 결제하기" (재시도 유도)
```

**추천 가게 조건**
```javascript
const recommendStores = nearbyStores.filter(store =>
  store.id !== currentStore.id &&
  store.luckyBagCount > 0 &&  // 재고 있음
  store.status === 'TODAY_OPEN' || store.status === 'TOMORROW_OPEN'  // 픽업 가능
);
```

---

## 02/ Case 분기

| Case | 조건 | 동작 |
|------|------|------|
| "다시 결제하기" 터치 | - | 결제하기 화면 복귀 (입력값 유지) |
| "홈으로" 터치 | - | 소비자 홈 이동 |
| 추천 가게 터치 | - | 해당 가게 상세 이동 |
| 추천 가게 없음 | 조건 만족 가게 0개 | 추천 섹션 숨김 |

---

## Figure Out...

### Scope 확정
- [ ] "다시 결제하기" 시 이전 입력값(수량, 쿠폰) 유지 방법?
- [ ] 추천 가게 최대 몇 개? (3개? 5개?)
- [ ] 연속 실패 시 특별 처리 필요?

### API 명세 (신규 필요)

#### 1. 근처 추천 가게 목록 API
- Epic 3과 동일한 API 활용
```
GET /api/places/nearby?lat={위도}&lng={경도}&excludePlaceId={현재가게ID}
```

#### 2. 실패한 주문 정보 조회 (재결제용)
- [ ] 결제 실패 시 주문 정보가 어디까지 저장되는지 확인 필요
- [ ] "다시 결제하기" 시 이전 주문 정보 조회 API 필요 여부

**옵션 A: 프론트 상태 유지**
- 결제 실패 시 프론트에서 주문 정보(수량, 쿠폰ID, 가게ID) 유지
- 별도 API 불필요

**옵션 B: 임시 주문 조회 API**
```
GET /api/orders/{orderId}/retry
```
- 실패한 주문의 정보 조회
- Response: 가게ID, 수량, 선택한 쿠폰ID 등

#### 3. PG 실패 사유 (Nice-to-have)
- [ ] 토스페이먼츠에서 실패 사유 코드 받아올 수 있는지 확인
- [ ] 받아올 수 있다면 프론트에서 표시할 메시지 매핑 필요

---
---

# 전체 Figure Out 요약

## Scope 회의 필수 확인

| Epic | 항목 | 질문 |
|------|------|------|
| 1 | 긴급 재고 | 2개 이하? 3개 이하? 디자인은? |
| 2 | 이용 매너 | 3단계 **완전 제거** vs 스킵 가능? |
| 2 | 쿠폰 바텀시트 | 기존 Drawer 활용? 별도 구현? |
| 3 | 추천 가게 | 정렬/필터 조건 확정 |
| 4 | 재결제 | 입력값 유지 방법 |

---

## API 명세 필요 사항

### 신규 API

| API | 용도 | Epic | 우선순위 |
|-----|------|------|----------|
| `GET /api/places/nearby` | 근처 추천 가게 목록 | 3, 4 | **필수** |

### 기존 API 확인 필요

| 확인 사항 | Epic | 상세 |
|----------|------|------|
| 결제 완료 응답에 가게 정보 포함 여부 | 3 | 예약 정보 카드 표시용 (가게명, 주소, 픽업시간) |
| 결제 실패 시 주문 정보 저장 여부 | 4 | "다시 결제하기" 시 이전 정보 유지 |
| PG 실패 사유 코드 전달 여부 | 4 | 실패 원인 상세 표시 (Nice-to-have) |

### API 상세 스펙

#### `GET /api/places/nearby`
```
GET /api/places/nearby?lat={위도}&lng={경도}&excludePlaceId={가게ID}&limit={개수}
```

| 파라미터 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| lat | number | Y | 현재 위치 위도 |
| lng | number | Y | 현재 위치 경도 |
| excludePlaceId | number | N | 제외할 가게 ID |
| limit | number | N | 최대 개수 (기본 3) |

**필터 조건**
- `luckyBagCount > 0`
- `status IN ('TODAY_OPEN', 'TOMORROW_OPEN')`

---

## 개발 공수 확인

| 작업 | 예상 영향 |
|------|----------|
| `UsageMannerFunnel` 제거 | `OrderFunnel` 수정 필요 |
| `CouponSelector` 바텀시트화 | Portal → Drawer/Sheet 변경 |
| 결제 완료 추천 가게 | **신규 API 필요** |
| 결제 실패 CTA 변경 | 라우팅 로직 수정 |
